# AppBuilder Platform - Cursor Rules

## üö® KRITISK: Database & Migrasjoner

**F√òR du oppretter nye database-tabeller:**

1. ALLTID kj√∏r: `grep -r "CREATE TABLE" supabase/migrations/`
2. Sjekk om lignende tabell allerede finnes
3. Gjenbruk eksisterende tabeller fremfor √• lage nye

**Eksisterende tabeller du M√Ö kjenne til:**

| Tabell | Migrasjon | Beskrivelse |
|--------|-----------|-------------|
| `workflow_templates` | 20251126000001 | n8n workflow-maler |
| `tenant_workflows` | 20251126000001 | Aktiverte workflows per tenant |
| `integration_definitions` | 20251110200947 | Unified integrasjonskatalog (type-kolonne) |
| `tenant_integrations` | 20251023133841 | Per-tenant integrasjonsconfig med scope |
| `vault_credentials` | Tidligere | Krypterte credentials (Vault) for alle integrasjoner |
| `n8n_workflow_mappings` | 20251203130000 | n8n webhook mappings (tidligere mcp_tenant_workflow_map) |
| `capabilities` | Tidligere | Capability-katalog |
| `capability_bundles` | 20251202120000 | Capability-pakker |
| `tenant_capabilities` | Tidligere | Aktiverte capabilities |
| `tenants` | Tidligere | Multi-tenant config |
| `user_roles` | Tidligere | RBAC roller |

**MCP (Model Context Protocol) - Riktig bruk:**

MCP er Anthropics protokoll for AI-verkt√∏y. Bruk BARE "mcp_" prefiks for:
- `mcp_tool_registry` - AI verkt√∏y
- `mcp_action_registry` - AI aksjoner
- `mcp_action_log` - AI aksjon-logger
- `mcp_tenant_policy` - MCP policy

IKKE bruk "mcp_" for generelle integrasjoner, webhooks eller API-n√∏kler!

**Secrets & API-n√∏kler - Tre lagringsmetoder:**

| Metode | Hvor | N√•r brukes | Eksempel |
|--------|------|------------|----------|
| **1. Functions Secrets** | Supabase Dashboard ‚Üí Functions ‚Üí Secrets | Platform-niv√• secrets for Edge Functions | `N8N_API_KEY_APPBUILDER_PLATFORM` |
| **2. vault_credentials** | V√•r egen tabell i public schema | Tenant-spesifikke credentials med UI-admin | n8n MCP token per tenant |
| **3. Supabase Vault** | Supabase ‚Üí Integrations ‚Üí Vault | Ekte kryptering med n√∏kkelh√•ndtering (BETA) | Sensitiv data som krever audit |

**BESLUTNING - Hva bruker vi:**
- **Platform-secrets** ‚Üí Functions Secrets (env vars i Deno)
- **Tenant-secrets** ‚Üí `vault_credentials` tabell (admin UI p√• `/admin/credentials`)
- **Supabase Vault** ‚Üí Ikke i bruk (BETA, mer kompleks)

**VIKTIG:** `vault_credentials.encrypted_value` er pt. IKKE kryptert (TODO). 
For ekte kryptering, migrer til Supabase Vault eller implementer pg_crypto.

Edge functions m√• deployes p√• nytt (`npx supabase functions deploy <name>`) for √• laste nye Functions Secrets.

**Migrasjonsregler:**

- Bruk `IF NOT EXISTS` for CREATE TABLE
- Bruk `ON CONFLICT DO UPDATE` for INSERT
- ALLTID legg til RLS policies
- Legg til COMMENT ON TABLE/COLUMN

---

## üìÅ Modulstruktur

Alle moduler f√∏lger denne strukturen under `src/modules/core/<modul>/`:

```
‚îú‚îÄ‚îÄ components/    # React komponenter
‚îú‚îÄ‚îÄ hooks/         # Custom hooks (useX)
‚îú‚îÄ‚îÄ services/      # Business logic
‚îú‚îÄ‚îÄ types/         # TypeScript types
‚îî‚îÄ‚îÄ index.ts       # Public API (eksporter alt her)
```

**N√•r du lager ny funksjonalitet:**

1. Finn riktig modul f√∏rst (`company`, `project`, `capabilities`, etc.)
2. Sjekk `index.ts` for eksisterende exports
3. F√∏lg samme pattern som eksisterende filer

---

## üîë Viktige systemer som finnes

### Integrasjoner

- **n8n**: Prim√¶r integrasjons-hub, bruk `workflow_templates`
- **Adapter pattern**: `src/modules/core/integrations/adapters/`
- **Webhook support**: `src/modules/core/integrations/webhooks/`

### Capabilities

- **Registry**: `src/modules/core/capabilities/`
- **Runtime**: `CapabilityLoader.tsx` for micro-frontends
- **Bundles**: Forh√•ndskonfigurerte pakker

### Permissions

- **RBAC**: `src/modules/core/permissions/`
- **Roller**: `platform_owner`, `platform_admin`, `tenant_owner`, `tenant_admin`, `tenant_member`
- **RLS**: Alle tabeller har Row Level Security

---
## Autolagring
- Bruk alltid den eksisterende useAutoSave hooken som har:

1.5 sekunder delay (konfigurerbart)
Status-indikator (pending/saving/saved/error)
Retry-logikk ved nettverksfeil
Hindrer lagring hvis innhold ikke har endret seg
const { status, trigger } = useAutoSave({
  onSave: async () => { await updateTestPayload(workflowId, tenantId, payload); },
  delay: 1500,
  enabled: !!tenantId && !!workflowId
});


## üé® Frontend Patterns

### UI Components

- Bruk shadcn/ui komponenter fra `src/components/ui/`
- F√∏lg eksisterende styling (Tailwind)
- Lucide icons

### Hooks

- `useTenant()` - N√•v√¶rende tenant context
- `useUserRole()` - Brukerens roller
- `useCapabilities()` - Tilgjengelige capabilities
- `useSupabase()` - Database client

### State Management

- React Query for server state
- Context for global client state
- Lokale hooks for komponent-state

---

## üìù Kodekonvensjoner

### Naming

- Filer: `kebab-case.ts` eller `PascalCase.tsx` for komponenter
- Types: `PascalCase` med `.types.ts` suffix
- Services: `camelCaseService.ts`
- Hooks: `useX.ts`

### TypeScript

- Strict mode aktivert
- Eksporter types fra `index.ts`
- Interface over type for objekter
- Bruk `Record<string, T>` for dictionaries

### Database

- snake_case for kolonner
- Plural for tabellnavn
- UUID som primary keys
- `created_at`, `updated_at` p√• alle tabeller

---

## ‚ö° Supabase Edge Functions

Lokasjon: `supabase/functions/`

**Eksisterende funksjoner √• kjenne til:**

- `n8n-sync` - Bi-direktional sync med n8n (list, pull, push, update, activate)
- `trigger-n8n-workflow` - Starter n8n workflows via webhook
- `n8n-proxy` - Proxy for webhook-kall til n8n
- `generate-questions` - AI-genererte sp√∏rsm√•l
- `brreg-*` - Br√∏nn√∏ysund integrasjon
- `ai-mcp-chat` - AI-chat med MCP tools

**F√∏r ny funksjon:**

1. Sjekk om eksisterende kan utvides
2. F√∏lg samme struktur
3. Husk CORS og auth
4. Bruk `_shared/cors.ts` for CORS headers

---

## üîç F√∏r du starter

**Sjekkliste for nye features:**

- [ ] S√∏k i kodebasen f√∏rst (`grep`, `codebase_search`)
- [ ] Les relevante `index.ts` filer
- [ ] Sjekk migrations for database-schema
- [ ] Les docs/ for arkitektur-beslutninger
- [ ] Forst√• tenant-isolation

**Ved database-endringer:**

- [ ] Kj√∏r `grep -r "CREATE TABLE" supabase/migrations/`
- [ ] Sjekk eksisterende tabeller som kan gjenbrukes
- [ ] Planlegg RLS policies
- [ ] Vurder indekser

---

## üìö Dokumentasjon

- `docs/architecture.md` - Overordnet arkitektur
- `docs/capabilities/` - Capability-spesifikasjoner
- `docs/n8n-workflows/` - Workflow-dokumentasjon
- `docs/roles-and-permissions.md` - RBAC system
- [ ] Oppdater alltid dokumentasjonen n√•r du lager nye funksjoner, inkludert sequence og flytdiagrammer

---

## üîå Integrasjonsarkitektur (v2)

### Fire integrasjonstyper

| Type | Beskrivelse | Eksempler |
|------|-------------|-----------|
| `ai_provider` | AI-tjenester (BYOK) | OpenAI, Anthropic, Google AI |
| `workflow` | n8n workflows | Sync Odoo, Export Notion |
| `direct_api` | Direkte API-kall | Br√∏nn√∏ysund, valutakurser |
| `mcp_tool` | MCP-protokoll tools | AI-assisterte handlinger |

### Hierarkisk scope for AI providers

```
Capability > App > Tenant > Platform default
```

Bruk `get_effective_ai_provider()` for √• finne riktig provider.

### n8n bi-direktional sync

**Flyt:**
1. Generer workflow JSON p√• platform (AI-assistert eller manuelt)
2. Push til n8n via `n8n-sync` edge function
3. Juster workflow i n8n editor
4. Sync tilbake til platform med `N8nSyncService.syncToDatabase()`
5. Knytt workflow til apps/capabilities

**Tjenester:**
- `N8nSyncService` - Push/pull mellom platform og n8n
- `n8n-sync` edge function - API-kommunikasjon
- `integration_definitions` med type='workflow' - Lagrer workflow metadata

### Admin UI

- `/admin/integrations?tab=workflows` - Workflow-administrasjon med n8n sync
- `/admin/integrations?tab=definitions` - Integrasjonskatalog

**Unntak:** Br√∏nn√∏ysund (brreg) kj√∏rer som edge function pga. ytelse.
- Sp√∏r alltid om du mener det er best med en direkte integrasjon

---

## üß© Capability Design

### Visibility (hvem ser capability)

| Visibility | Beskrivelse | Eksempler |
|------------|-------------|-----------|
| `internal` | Kun platform-team | tenant-management, app-builder |
| `partner` | Partnere + internt | erp-system-management |
| `public` | Alle kunder | task-management, calendar-view |

### Core Capabilities (alltid inkludert)

Disse har `is_core = true` og kan ikke fjernes fra kundeapper:

- `auth-core` - Sign-up, sign-in, password reset
- `user-profile` - Se/redigere egen profil
- `user-account-settings` - Passord, 2FA, notifikasjoner
- `basic-authorization` - Forenklet rolle-basert tilgang

---

## üõ°Ô∏è Defensiv TypeScript

### API-responser

API-er kan returnere uventede strukturer. ALLTID:

```typescript
// ‚ùå Farlig - antar array
data.items.length

// ‚úÖ Sikkert - sjekk f√∏rst
Array.isArray(data.items) ? data.items.length : 0
```

### Objekter vs primitiver

```typescript
// API kan returnere { question_text: "..." } i stedet for "..."
const text = typeof question === 'string' 
  ? question 
  : question?.question_text ?? '';
```

### Loading states

```typescript
// ‚úÖ Start med loading=true n√•r data hentes ved mount
const [isLoading, setIsLoading] = useState(true);
```

---

## ‚öõÔ∏è React Patterns

### State plassering

- Flytt state til komponenten som bruker den
- Foreldre skal ikke holde state som bare barn trenger
- Props drilling = signal om at state er feil plassert

### UI-komponenter

```tsx
// ‚ùå <Label> uten htmlFor som flex-container
<Label className="flex items-center gap-2">
  <span>Tekst</span>
</Label>

// ‚úÖ Bruk <div> for layout uten form-assosiasjoner
<div className="flex items-center gap-2">
  <span>Tekst</span>
</div>
```

---

## üö´ Unng√•

- Duplisering av eksisterende tabeller/funksjonalitet
- Hardkodede tenant IDs (bruk context)
- Direkte database queries uten RLS
- Nye UI-komponenter n√•r shadcn har tilsvarende
- Lange AI-genererte kommentarer
- Egne integrasjonsadaptere (bruk n8n)
- Anta datatyper fra API uten sjekk
